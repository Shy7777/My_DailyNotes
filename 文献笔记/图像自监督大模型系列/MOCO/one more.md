Key encoder（键编码器）是对比学习框架中用于生成“键”向量（key representations）的神经网络模块。它的作用是将输入样本（通常是图像的某种视图）编码成一个向量，用于与查询向量（query）进行相似度比较，从而计算对比损失。

---

## 在 MoCo 中，key encoder 的定义与作用

在 MoCo 框架中，存在两个编码器：

| 编码器 | 输入 | 输出 | 作用 |
|--------|------|------|------|
| **Query Encoder** \( f_q \) | 图像视图 \( x_q \) | 查询向量 \( q \) | 用于构造对比损失的“查询” |
| **Key Encoder** \( f_k \) | 图像视图 \( x_k \) | 键向量 \( k \) | 用于构造对比损失的“键” |

MoCo 的训练目标是让查询向量 \( q \) 与其对应的正样本键 \( k^+ \) 相似，与其他负样本键 \( k^- \) 不相似。

---

## 为什么 key encoder 要用动量更新？

MoCo 的关键创新之一是使用动量更新的 key encoder，而不是直接复制 query encoder。这是因为：

- 队列中的键向量来自多个 mini-batch，不能回传梯度
- 如果直接复制 query encoder，编码器变化太快，导致键向量不一致
- 动量更新可以让 key encoder 平滑演化，保持一致性

动量更新公式如下：

\[
\theta_k \leftarrow m \cdot \theta_k + (1 - m) \cdot \theta_q
\]

其中：

- \( \theta_k \)：key encoder 的参数
- \( \theta_q \)：query encoder 的参数
- \( m \)：动量系数，通常设为 0.999

---

## 实验验证：动量对 key encoder 的影响

论文中做了动量系数的消融实验，结果如下：

| 动量 \( m \) | 准确率 (%) |
|-------------|------------|
| 0           | 训练失败   |
| 0.9         | 55.2       |
| 0.99        | 57.8       |
| 0.999       | 59.0       |
| 0.9999      | 58.9       |

说明：key encoder 的一致性对训练稳定性和性能至关重要。

---

## 总结

**Key encoder 是 MoCo 中用于生成键向量的编码器，其核心作用是构建对比学习中的负样本池。通过动量更新，它保持编码器的一致性，使得训练更加稳定和高效。**
